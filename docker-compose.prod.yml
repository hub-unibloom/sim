services:
  caddy:
    image: caddy:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN_NAME=${DOMAIN_NAME:-localhost}
    volumes:
      - ./docker/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - simstudio

  simstudio:
    image: ghcr.io/simstudioai/simstudio:latest
    restart: unless-stopped
    ports:
      - '3000:3000'
    deploy:
      resources:
        limits:
          memory: 8G
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - BETTER_AUTH_URL=https://${DOMAIN_NAME:-localhost}
      - NEXT_PUBLIC_APP_URL=https://${DOMAIN_NAME:-localhost}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - API_ENCRYPTION_KEY=${API_ENCRYPTION_KEY:-}
      - INTERNAL_API_SECRET=${INTERNAL_API_SECRET}
      - COPILOT_API_KEY=${COPILOT_API_KEY}
      - SIM_AGENT_API_URL=${SIM_AGENT_API_URL}
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}
      - SOCKET_SERVER_URL=http://realtime:3002
      - NEXT_PUBLIC_SOCKET_URL=https://${DOMAIN_NAME:-localhost}/socket.io/
      # Cheshire Memory System (Cascata Integration)
      - CASCATA_POSTGRES_URL=${CASCATA_POSTGRES_URL:-${DATABASE_URL}}
      - CHESHIRE_EMBEDDING_MODEL=${CHESHIRE_EMBEDDING_MODEL:-text-embedding-3-small}
      - CHESHIRE_EMBEDDING_DIM=${CHESHIRE_EMBEDDING_DIM:-1536}
      - CHESHIRE_LLM_MODEL=${CHESHIRE_LLM_MODEL:-gpt-4-turbo}
      - N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL:-}
    depends_on:
      realtime:
        condition: service_healthy
    healthcheck:
      test: [ 'CMD', 'wget', '--spider', '--quiet', 'http://127.0.0.1:3000' ]
      interval: 90s
      timeout: 5s
      retries: 3
      start_period: 10s

  realtime:
    image: ghcr.io/simstudioai/realtime:latest
    restart: unless-stopped
    ports:
      - '3002:3002'
    deploy:
      resources:
        limits:
          memory: 1G
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - NEXT_PUBLIC_APP_URL=https://${DOMAIN_NAME:-localhost}
      - BETTER_AUTH_URL=https://${DOMAIN_NAME:-localhost}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - INTERNAL_API_SECRET=${INTERNAL_API_SECRET}
      # Redis removed - defaulting to memory
    healthcheck:
      test: [ 'CMD', 'wget', '--spider', '--quiet', 'http://127.0.0.1:3002/health' ]
      interval: 90s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  caddy_data:
  caddy_config:
